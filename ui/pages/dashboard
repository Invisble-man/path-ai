# ui/pages/dashboard.py
from __future__ import annotations

import streamlit as st

from core.scoring import compute_scores
from ui.components import render_readiness_console, ui_notice


def page_dashboard():
    """
    Dashboard = Readiness Console + Diagnostics + Critical Submission Info + Warnings + Quick Actions
    Assumes these session keys may exist:
      - rfp_text, rfp_filename, rfp_pages, rfp_meta (dict)
      - company (dict)
      - draft (dict) and/or drafts (dict)
    """

    ss = st.session_state

    # Title area
    st.markdown("## Dashboard")
    st.caption("No clutter. Compliance, win strength, progress — plus only critical submission signals.")

    # Hard requirement: need an RFP for meaningful dashboard
    if not (ss.get("rfp_text") or "").strip():
        ui_notice("UPLOAD REQUIRED", "Start by uploading an RFP on Upload RFP, then click Analyze.", tone="warn")
        return

    # Compute scores + persist for sidebar widgets
    scores = compute_scores(ss)
    ss["scores"] = scores

    # Readiness Console (banner + bars + walker)
    render_readiness_console(
        scores=scores,
        build_version=ss.get("build_version", "v1"),
        build_date=ss.get("build_date", ""),
    )

    # --- Top: Diagnostics + Critical Submission Info ---
    st.markdown("### RFP Diagnostics")
    d1, d2, d3 = st.columns(3)
    with d1:
        st.metric("Filename", ss.get("rfp_filename") or "—")
    with d2:
        st.metric("Pages (est.)", int(ss.get("rfp_pages") or 0))
    with d3:
        st.metric("Characters", len(ss.get("rfp_text") or ""))

    meta = ss.get("rfp_meta", {}) or {}

    st.markdown("### Critical Submission Info")
    c1, c2, c3 = st.columns(3)
    with c1:
        st.write("**Due Date:**", meta.get("due_date") or "—")
        st.write("**Solicitation:**", meta.get("solicitation") or "—")
    with c2:
        st.write("**Submit Email:**", meta.get("submit_email") or "—")
        st.write("**Submission Method:**", meta.get("submission_method") or "—")
    with c3:
        st.write("**Agency:**", meta.get("agency") or "—")
        st.write("**Title:**", meta.get("title") or "—")

    # --- Warnings (eligibility/compliance) ---
    warnings = scores.get("warnings", []) or []
    if warnings:
        st.markdown("### Warnings")
        for w in warnings:
            st.warning(w)

    # --- Progress breakdown cards (quick) ---
    st.markdown("### Snapshot")
    s1, s2, s3 = st.columns(3)
    with s1:
        st.metric("Compliance", f"{float(scores.get('compliance_pct', 0.0)):.0f}%")
    with s2:
        st.metric("Win Strength", f"{float(scores.get('win_strength_pct', 0.0)):.0f}%")
    with s3:
        st.metric("Overall Progress", f"{float(scores.get('overall_progress_pct', 0.0)):.0f}%")

    # --- Quick actions ---
    st.markdown("---")
    st.markdown("### Quick Actions")
    a, b, c, d = st.columns(4)
    with a:
        if st.button("Upload RFP", use_container_width=True):
            ss["current_page"] = "Upload RFP"
            st.rerun()
    with b:
        if st.button("Company Info", use_container_width=True):
            ss["current_page"] = "Company Info"
            st.rerun()
    with c:
        if st.button("Draft Proposal", use_container_width=True):
            ss["current_page"] = "Draft Proposal"
            st.rerun()
    with d:
        if st.button("Export", use_container_width=True):
            ss["current_page"] = "Export"
            st.rerun()

    # --- Optional: show minimal internal state health (dev-friendly, not cluttery) ---
    with st.expander("System Health (minimal)", expanded=False):
        company = ss.get("company", {}) or {}
        draft = ss.get("draft", {}) or {}
        drafts = ss.get("drafts", {}) or {}
        st.write("Company fields captured:", len([k for k, v in company.items() if str(v).strip()]))
        st.write("Draft keys present:", sorted(list(draft.keys()))[:20])
        st.write("Draft sections present:", sorted(list(drafts.keys()))[:20])